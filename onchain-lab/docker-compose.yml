version: "3.8"

services:
  bitcoind:
    image: ruimarinho/bitcoin-core:26
    container_name: onchain-bitcoind
    restart: unless-stopped
    environment:
      - BITCOIN_RPCUSER=${BTC_RPC_USER}
      - BITCOIN_RPCPASSWORD=${BTC_RPC_PASS}
      - BITCOIN_EXTRA_ARGS=-txindex=1 -server=1 -rpcallowip=0.0.0.0/0 -rpcbind=0.0.0.0 -dbcache=16384 -maxmempool=500 -prune=0
    ports:
      - "8332:8332"
      - "8333:8333"
    volumes:
      - ./data/bitcoind:/home/bitcoin/.bitcoin
      - ./docker/bitcoind/bitcoin.conf:/home/bitcoin/.bitcoin/bitcoin.conf:ro
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-conf=/home/bitcoin/.bitcoin/bitcoin.conf", "getblockcount"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
